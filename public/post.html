<script>
  function escapeToBr(text) {
    return (text || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;")
      .replaceAll("\n", "<br>");
  }

  function ymd(dateStr) {
    if (!dateStr) return "";
    const dt = new Date(dateStr);
    if (isNaN(dt.getTime())) return "";
    return `${dt.getFullYear()}/${String(dt.getMonth()+1).padStart(2,"0")}/${String(dt.getDate()).padStart(2,"0")}`;
  }

  function humanType(ct) {
    if (!ct) return "";
    const s = String(ct).toLowerCase();
    if (s.includes("pdf")) return "PDF";
    if (s.includes("image")) return "Image";
    if (s.includes("zip")) return "ZIP";
    return ct;
  }

  function buildAttachmentRow(att) {
    const row = document.createElement("div");
    row.className = "attach-item";

    const left = document.createElement("div");
    left.className = "attach-left";

    const name = document.createElement("div");
    name.className = "attach-name";
    name.textContent = att.filename || "file";

    const meta = document.createElement("div");
    meta.className = "attach-meta";
    const t = humanType(att.content_type);
    meta.textContent = t ? t : "";

    left.appendChild(name);
    if (meta.textContent) left.appendChild(meta);

    const actions = document.createElement("div");
    actions.className = "attach-actions";

    const openBtn = document.createElement("a");
    openBtn.className = "btn-sm";
    openBtn.textContent = "開く";
    openBtn.target = "_blank";
    openBtn.rel = "noopener";
    openBtn.href = `/api/attachments/${encodeURIComponent(att.id)}/download`;

    actions.appendChild(openBtn);

    row.appendChild(left);
    row.appendChild(actions);
    return row;
  }

  async function fetchPost(postId) {
    const res = await fetch(`/api/posts/${encodeURIComponent(postId)}`, { method: "GET" });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.message || "Not Found");
    return data;
  }

  async function checkLoggedIn() {
    try {
      const res = await fetch("/api/me", { method: "GET", credentials: "include" });
      return res.ok;
    } catch {
      return false;
    }
  }

  async function fetchAttachments(postId) {
    const res = await fetch(`/api/posts/${encodeURIComponent(postId)}/attachments`, {
      method: "GET",
      credentials: "include",
    });

    if (res.status === 401) return { unauthorized: true, items: [] };

    const data = await res.json().catch(() => ([]));
    if (!res.ok) throw new Error((data && data.message) || "Failed to load attachments");

    const items = Array.isArray(data) ? data : (data.items || []);
    return { unauthorized: false, items };
  }

  function bindEnterClick(el, handler) {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        handler();
      }
    });
  }

  (async function init() {
    const params = new URLSearchParams(location.search);
    const postId = (params.get("id") || "").trim();

    const titleEl = document.getElementById("post-title");
    const dateEl = document.getElementById("post-date");
    const bodyEl = document.getElementById("post-content");

    const head = document.getElementById("attach-head");
    const attachBody = document.getElementById("attach-body");
    const attachList = document.getElementById("attach-list");

    if (!postId) {
      titleEl.textContent = "Not Found";
      dateEl.textContent = "";
      bodyEl.innerHTML = "";
      // click 添付資料 -> login
      head.addEventListener("click", () => location.href = "login.html");
      bindEnterClick(head, () => location.href = "login.html");
      return;
    }

    // 1) load post
    try {
      const post = await fetchPost(postId);
      document.title = post.title || "Post";
      titleEl.textContent = post.title || "";
      dateEl.textContent = ymd(post.created_at);
      bodyEl.innerHTML = escapeToBr(post.content || "");
    } catch (e) {
      console.error(e);
      titleEl.textContent = "Not Found";
      dateEl.textContent = "";
      bodyEl.innerHTML = "";
      head.addEventListener("click", () => location.href = "login.html");
      bindEnterClick(head, () => location.href = "login.html");
      return;
    }

    // 2) auth check
    const loggedIn = await checkLoggedIn();

    if (!loggedIn) {
      // ✅ đúng yêu cầu anh: click 添付資料 -> bay luôn đến login
      head.addEventListener("click", () => location.href = "login.html");
      bindEnterClick(head, () => location.href = "login.html");
      attachBody.style.display = "none";
      return;
    }

    // 3) logged in -> click head: toggle list
    let opened = false;

    async function openOrToggle() {
      if (!opened) {
        // load attachments once
        try {
          const r = await fetchAttachments(postId);
          if (r.unauthorized) {
            location.href = "login.html";
            return;
          }

          const items = r.items || [];
          attachList.innerHTML = "";

          if (!items.length) {
            // nếu không có file, vẫn mở nhưng hiển thị 1 dòng gọn
            const empty = document.createElement("div");
            empty.className = "attach-item";
            empty.textContent = "添付資料はありません";
            attachList.appendChild(empty);
          } else {
            items.forEach(att => attachList.appendChild(buildAttachmentRow(att)));
          }

          attachBody.style.display = "block";
          opened = true;
          return;
        } catch (e) {
          console.error(e);
          // fail thì không mở
          attachBody.style.display = "none";
          opened = false;
          return;
        }
      }

      // toggle close/open
      if (attachBody.style.display === "none") attachBody.style.display = "block";
      else attachBody.style.display = "none";
    }

    head.addEventListener("click", openOrToggle);
    bindEnterClick(head, openOrToggle);
  })();
</script>
